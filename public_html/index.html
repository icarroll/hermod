<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jdenticon@2.1.0"></script>
  <script>
    window.jdenticon_config = {
      lightness: {
        color: [0.33, 0.67],
        grayscale: [0.17, 0.67],
      },
      saturation: {
        color: 1.0,
        grayscale: 0.0,
      },
      backColor: "#ffffff"
    };
  </script>
  <script src="sodium.js"></script>
  <script src="zxcvbn.js"></script>

<style>
body {
}

#login {
  height: 100%;
  display: grid;
  grid-template-columns: auto;
  grid-template-rows: auto;
  align-items: center;
  justify-items: center;
}

#chat {
  height: 100%;
  display: grid;
  grid-template-columns: auto 20%;
  grid-template-rows: 85% 15%;
}

svg {
  position: relative;
  top: 10px;

  border: 1px solid black;
}

#log {
  grid-column: 1;
  grid-row: 1;

  overflow-y: scroll;
}

#log div {
  background: #f7f7f7;
  margin-right: 10px;
}

#log svg {
  float: left;
  top: 0px;
}

svg ~ p {
  margin-left: 50px;
}

#who {
  grid-column: 2;
  grid-row: 1;

  overflow-y: scroll;

  border-left: 1px solid black;
  padding-left: 10px;
}

#who ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#input {
  grid-column: 1 / span 2;
  grid-row: 2;

  border-top: 1px solid black;
}

#input input {
  width: 80%;
}
</style>
</head>

<!--
<body onclick="inputfocus()">
-->
<body>

<div id="app">
<div id="login">
  <div>
    <h1>Hermod chat</h1>
    Username: <input id="id_salt" v-model="self_user.id_salt"> <br/>
    Password: <input id="password" v-model="self_user.password"> <br/>
    Your password would take {{crack_time}} to crack. <br/>
    <button onclick="calculate()">Calculate your idkey</button>
  </div>
  <div id="calculate" style="display: none">
    {{please_wait_msg}} <br/>
    <svg width="96" height="96" v-bind:data-jdenticon-value="self_user.idkey"></svg>
  </div
</div>

<div id="chat" style="display: none">
  <div id="log">
    <div v-for="item in log_items">
      <svg width="32" height="32" v-bind:data-jdenticon-value="item.idkey"></svg>
      <p>
        <strong>{{item.nickname}}:</strong>
        {{item.message}}
      </p>
    </div>
  </div>
  <div id="who">
    <h3>Users here:</h3>
    <ul>
      <li v-for="item in users">
        <svg width="32" height="32" v-bind:data-jdenticon-value="item.idkey"></svg>
        <strong>{{item.nickname}}</strong>
      </li>
    </ul>
  </div>
  <div id="input">
    <svg width="64" height="64" v-bind:data-jdenticon-value="self_user.idkey"></svg>
    <strong>{{self_user.nickname}}:</strong>
    <input id="input_text" v-model="input">
  </div>
</div>
</div>

<script>
function calculate() {
  document.getElementById("calculate").style.display = "";
  app.please_wait_msg = "Calculating, please wait...";

console.log("starting hash");
  seed = sodium.crypto_pwhash(32, app.self_user.password, sodium.crypto_generichash(16, app.self_user.id_salt), 256, 10000000, sodium.crypto_pwhash_ALG_ARGON2ID13)
console.log("done with hash");
  keypair = sodium.sign_seed_keypair(seed);
console.log("created keypair");
  app.privkey = keypair.privateKey;
  app.idkey = keypair.publicKey;

  app.please_wait_msg = "";
}

function scrolldown() {
  logdiv = document.getElementById("log");
  logdiv.scrollTop = logdiv.scrollHeight;
}

function inputfocus() {
  // document.getElementById("input_text").focus();
}
</script>

<script>
  var app = new Vue({
    el: '#app',
    data: {
      self_user: {
        id_salt: "",
        password: "",
        privkey: "",
        idkey: "",
        nickname: "",
      },
      please_wait_msg: "",
      users: [],
      log_items: [],
      input: "",
    },
    mounted: function () {
      jdenticon.update("svg");
      scrolldown();
      inputfocus();
    },
    updated: function () {
      jdenticon.update("svg");
      scrolldown();
      inputfocus();
    },
    computed: {
      crack_time: function() {
        return zxcvbn(this.self_user.password).crack_times_display.offline_slow_hashing_1e4_per_second;
      },
    },
  });
</script>

</body>
</html>
