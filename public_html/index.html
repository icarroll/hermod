<html>
<head>
  <!-- <script src="vue.min.js"></script> -->
  <script src="vue.js"></script>
  <script src="jdenticon.min.js"></script>
  <script>
    window.jdenticon_config = {
      lightness: {
        color: [0.33, 0.67],
        grayscale: [0.17, 0.67],
      },
      saturation: {
        color: 1.0,
        grayscale: 0.0,
      },
      backColor: "#ffffff"
    };
  </script>
  <script src="sodium.js"></script>
  <script src="zxcvbn.js"></script>

<style>
[data-tooltip] {
  position: relative;
}

[data-tooltip]:after {
  visibility: hidden;
  z-index: 1;
  position: absolute;
  content: attr(data-tooltip);
  width: auto;
  max-width: min-content;
  height: auto;
  background-color: white;
  border: 1px solid black;
}

[data-tooltip]:hover:after {
  visibility: visible;
}

.visible {
  display: '';
}

.invisible {
  display: none;
}

.login {
  height: 100%;
  display: grid;
  grid-template-columns: 1fr 2fr 1fr;
  grid-template-rows: 1fr 2fr 2fr 1fr;
}

.unamepword {
  grid-column: 2;
  grid-row: 2;
}

#calculate {
  grid-column: 2;
  grid-row: 3;
}

#chat {
  height: 100%;
  display: grid;
  grid-template-columns: 80% 20%;
  grid-template-rows: 85% 15%;
}

svg {
  border: 1px solid black;
}

#logs {
  grid-column: 1;
  grid-row: 1;

  display: flex;
  flex-direction: row;
}

.channel {
  flex-basis: 0;
  flex-grow: 1;
  border-right: 1px solid black;

  display: flex;
  flex-direction: column;
}

.channelname {
  flex-basis: auto;
  flex-grow: 0;
  border-bottom: 1px solid black;
}

.activechannel h2 {
  border-bottom: 5px solid blue;
}

.chatlog {
  flex-basis: 0;
  flex-grow: 1;
  overflow-y: scroll;
}

.chatlog div::after {
  /* clearfix hack */
  content: "";
  clear: both;
  display: table;
}

.msg {
  background: #f7f7f7;
  margin-right: 10px;
}

.msg svg {
  float: left;
}

svg ~ p {
  margin-left: 42px;
}

#who {
  grid-column: 2;
  grid-row: 1;

  overflow-y: scroll;

  padding-left: 10px;
}

#who ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

textarea {
  font-family: serif;
  resize: none;
}

#input {
  padding-top: 10px;
  grid-column: 1 / span 2;
  grid-row: 2;

  border-top: 1px solid black;

  display: grid;
  grid-template-columns: auto auto 1fr;
}

#input strong {
  padding-left: 10px;
  padding-right: 10px;
}
</style>

<script>
function calculate() {
  document.getElementById("calculate").style.display = "";

  app.self_user.nickname = app.self_user.id_salt;

  seed = sodium.crypto_pwhash(32, app.self_user.password, sodium.crypto_generichash(16, app.self_user.id_salt), 12, 10000000, sodium.crypto_pwhash_ALG_ARGON2ID13)
  keypair = sodium.crypto_sign_seed_keypair(seed);
  app.self_user.privkey = keypair.privateKey;
  app.self_user.idkey = keypair.publicKey;

  update_icons();
  app.$refs.nickname.focus();
}

function connect() {
  app.state="chat";
  document.getElementById("chat").style.display = "";

  // app.websocket = new WebSocket("ws://" + window.location.host + ":8192" + window.location.pathname.substring(0, window.location.pathname.lastIndexOf("/")) + "/chatsock");
  // app.websocket = new WebSocket("ws://" + window.location.host + ":8192" + "/chatsock");
  app.websocket = new WebSocket("ws://ada.cs.pdx.edu:8192/chatsock")
  // TODO: handle connection failure
  // TODO: handle slow connection
  // TODO: don't enable input box until connected?
  // TODO: don't erase input box until message sent?

  app.websocket.onmessage = function(e) {
    var receive = JSON.parse(e.data);
    var temp = atob(receive.idkey);
    var decidkey = new Uint8Array(temp.length);
    for (i=0; i<temp.length; i+=1) {decidkey[i] = temp.charCodeAt(i);}

    item = {idkey:decidkey, nickname:receive.nickname, message:receive.message};
    post_message(receive.channel, item)
    update_icons();
    scrolldown();
  }

  window.onbeforeunload = function() {return true;};
  inputfocus();
}

function join_channel(channel) {
  ix = app.channelnames.indexOf(channel);
  if (ix == -1) {
    if (channel === "") {
      app.channelnames.unshift(channel);
      app.chatlogs.unshift([]);
    }
    else {
      app.channelnames.push(channel);
      app.chatlogs.push([]);
    }
  }
}

function leave_channel(channel) {
  ix = app.channelnames.indexOf(channel);
  if (ix != -1) {
    app.chatlogs.splice(ix, 1);
    app.channelnames.splice(ix, 1);
  }
  if (app.focuschannel === channel) {
    app.focuschannel = app.channelnames[0];
  }
}

function post_message(channel, item) {
  ix = app.channelnames.indexOf(channel);
  if (ix != -1) {app.chatlogs[ix].push(item);}
}

function update_icons() {
  Vue.nextTick(function () {
    jdenticon.update("svg");
  });
}

function scrolldown() {
  Vue.nextTick(function () {
    logdivs = document.getElementsByClassName("chatlog");
    for (var i=0 ; i<logdivs.length ; i+=1) {
      logdivs[i].scrollTop = logdivs[i].scrollHeight;
    }
  });
}

function inputfocus() {
  document.getElementById("input_text").focus();
}
</script>
</head>

<body>

<div id="app">
<div class="login" v-bind:class="state==='login' ? visible : invisible">
  <div class="unamepword">
    <h1>Hermod chat</h1>
    Username: <input ref="id_salt" v-model="self_user.id_salt" @keyup.enter="$refs.password.focus()"> <br/>
    Password: <input ref="password" v-model="self_user.password" @keyup.enter="$refs.calculatebutton.click()"> <br/>
    Your password would take {{crack_time}} to crack. <br/>
    <button ref="calculatebutton" onclick="calculate()">Calculate your IDKey</button>
  </div>
  <div id="calculate" style="display: none">
    <hr/>
    Nickname: <input ref="nickname" v-model="self_user.nickname" @keyup.enter="$refs.connectbutton.click()"> <br/>
    IDKey:
    <svg width="128" height="128" v-bind:data-jdenticon-value="self_user.idkey"></svg> <br/>
    <br/>
    <button ref="connectbutton" onclick="connect()">Connect with this nickname and IDKey</button>
  </div>
</div>

<div id="chat" style="display: none">
  <div id="logs">
    <div class="channel" v-for="(chatlog,ix) in chatlogs" v-on:click="changechannel(ix)" v-bind:class="{activechannel: focuschannel===channelnames[ix]}">
      <div v-if="channelnames[ix]===''" data-tooltip="CC 3.0 BY - Icon by Freepik https://www.flaticon.com/authors/freepik">
        <object data="home.svg" width=32 height=32></object>
      </div>
      <h2 class="channelname">{{channelnames[ix]}}</h2>
      <div class="chatlog">
        <div class="msg" v-for="item in chatlog">
          <svg width="32" height="32" v-bind:data-jdenticon-value="item.idkey"></svg>
          <p>
            <strong>{{item.nickname}}:</strong>
            {{item.message}}
          </p>
        </div>
      </div>
    </div>
  </div>
  <div id="who">
    <h3>Users here:</h3>
    <ul>
      <li v-for="item in users">
        <svg width="32" height="32" v-bind:data-jdenticon-value="item.idkey"></svg>
        <strong>{{item.nickname}}</strong>
      </li>
    </ul>
  </div>
  <div id="input">
    <svg width="64" height="64" v-bind:data-jdenticon-value="self_user.idkey"></svg>
    <strong>{{self_user.nickname}}:</strong>
    <textarea id="input_text" ref="input_text" v-model="input" @keyup.enter="send"></textarea>
  </div>
</div>
</div>

<script>
  var app = new Vue({
    el: '#app',
    data: {
      state: "login",
      websocket: null,
      self_user: {
        id_salt: "",
        password: "",
        privkey: "",
        idkey: "",
        nickname: "",
      },
      users: [],
      channelnames: [""],
      focuschannel: "",
      chatlogs: [[]],
      input: "",
      send: function () {
        var encidkey = btoa(String.fromCharCode(...this.self_user.idkey));
        var obj = {idkey:encidkey, nickname:this.self_user.nickname, channel:this.focuschannel, message:this.input};
        this.websocket.send(JSON.stringify(obj));
        this.input = "";
      },
      changechannel: function (ix) {
        this.focuschannel = this.channelnames[ix];
        inputfocus();
      },
    },
    mounted: function () {
      this.$refs.id_salt.focus();
    },
    computed: {
      crack_time: function() {
        return zxcvbn(this.self_user.password).crack_times_display.offline_slow_hashing_1e4_per_second;
      },
    },
  });
</script>

</body>
</html>
