<html>
<head>
  <script src="vue.min.js"></script>
  <script src="jdenticon.min.js"></script>
  <script>
    window.jdenticon_config = {
      lightness: {
        color: [0.33, 0.67],
        grayscale: [0.17, 0.67],
      },
      saturation: {
        color: 1.0,
        grayscale: 0.0,
      },
      backColor: "#ffffff"
    };
  </script>
  <script src="sodium.js"></script>
  <script src="zxcvbn.js"></script>

<style>
body {
}

#login {
  height: 100%;
  display: grid;
  grid-template-columns: 1fr 2fr 1fr;
  grid-template-rows: 1fr 2fr 2fr 1fr;
}

#unamepword {
  grid-column: 2;
  grid-row: 2;
}

#calculate {
  grid-column: 2;
  grid-row: 3;
}

#chat {
  height: 100%;
  display: grid;
  grid-template-columns: 80% 20%;
  grid-template-rows: 85% 15%;
}

svg {
  position: relative;
  top: 10px;

  border: 1px solid black;
}

#log {
  grid-column: 1;
  grid-row: 1;

  overflow-y: scroll;
}

#log div {
  background: #f7f7f7;
  margin-right: 10px;
}

#log div::after {
  /* clearfix hack */
  content: "";
  clear: both;
  display: table;
}

#log svg {
  float: left;
  top: 0px;
}

svg ~ p {
  margin-left: 50px;
}

#who {
  grid-column: 2;
  grid-row: 1;

  overflow-y: scroll;

  border-left: 1px solid black;
  padding-left: 10px;
}

#who ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#input {
  grid-column: 1 / span 2;
  grid-row: 2;

  border-top: 1px solid black;
}
</style>

<script>
function calculate() {
  document.getElementById("calculate").style.display = "";

  app.self_user.nickname = app.self_user.id_salt;

  seed = sodium.crypto_pwhash(32, app.self_user.password, sodium.crypto_generichash(16, app.self_user.id_salt), 12, 10000000, sodium.crypto_pwhash_ALG_ARGON2ID13)
  keypair = sodium.crypto_sign_seed_keypair(seed);
  app.self_user.privkey = keypair.privateKey;
  app.self_user.idkey = keypair.publicKey;

  update_icons();
  document.getElementById("nickname").focus();
}

function connect() {
  document.getElementById("login").style.display = "none";
  document.getElementById("chat").style.display = "";

  // app.websocket = new WebSocket("ws://" + window.location.host + ":8192" + window.location.pathname.substring(0, window.location.pathname.lastIndexOf("/")) + "/chatsock");
  // app.websocket = new WebSocket("ws://" + window.location.host + ":8192" + "/chatsock");
  app.websocket = new WebSocket("ws://ada.cs.pdx.edu:8192/chatsock")
  // TODO: handle connection failure

  app.websocket.onmessage = function(e) {
    var receive = JSON.parse(e.data);
    var temp = atob(receive.idkey);
    var decidkey = new Uint8Array(temp.length);
    for (i=0; i<temp.length; i+=1) {decidkey[i] = temp.charCodeAt(i);}

    app.log_items.push({idkey:decidkey, nickname:receive.nickname, message:receive.payload});
    update_icons();
    scrolldown();
  }

  inputfocus();
}

function update_icons() {
  Vue.nextTick(function () {
    jdenticon.update("svg");
  });
}

function scrolldown() {
  logdiv = document.getElementById("log");
  logdiv.scrollTop = logdiv.scrollHeight;
}

function inputfocus() {
  document.getElementById("input_text").focus();
}
</script>
</head>

<body>

<div id="app">
<div id="login">
  <div id="unamepword">
    <h1>Hermod chat</h1>
    Username: <input id="id_salt" v-model="self_user.id_salt" @keyup.enter="document.getElementById('password').focus()"> <br/>
    Password: <input id="password" v-model="self_user.password" @keyup.enter="document.getElementById('calculatebutton').click()"> <br/>
    Your password would take {{crack_time}} to crack. <br/>
    <button id="calculatebutton" onclick="calculate()">Calculate your IDKey</button>
  </div>
  <div id="calculate" style="display: none">
    <hr/>
    Nickname: <input id="nickname" v-model="self_user.nickname" @keyup.enter="document.getElementById('connectbutton').click()"> <br/>
    IDKey:
    <svg width="128" height="128" v-bind:data-jdenticon-value="self_user.idkey"></svg> <br/>
    <br/>
    <button id="connectbutton" onclick="connect()">Connect with this nickname and IDKey</button>
  </div>
</div>

<div id="chat" style="display: none">
  <div id="log">
    <div v-for="item in log_items">
      <svg width="32" height="32" v-bind:data-jdenticon-value="item.idkey"></svg>
      <p>
        <strong>{{item.nickname}}:</strong>
        {{item.message}}
      </p>
    </div>
  </div>
  <div id="who">
    <h3>Users here:</h3>
    <ul>
      <li v-for="item in users">
        <svg width="32" height="32" v-bind:data-jdenticon-value="item.idkey"></svg>
        <strong>{{item.nickname}}</strong>
      </li>
    </ul>
  </div>
  <div id="input" style="display: grid; grid-template-columns: auto auto 1fr;">
    <svg width="64" height="64" v-bind:data-jdenticon-value="self_user.idkey"></svg>
    <strong>{{self_user.nickname}}:</strong>
    <textarea id="input_text" v-model="input" @keyup.enter="send"></textarea>
  </div>
</div>
</div>

<script>
  var app = new Vue({
    el: '#app',
    data: {
      websocket: null,
      self_user: {
        id_salt: "",
        password: "",
        privkey: "",
        idkey: "",
        nickname: "",
      },
      users: [],
      log_items: [],
      input: "",
      send: function () {
        var encidkey = btoa(String.fromCharCode(...app.self_user.idkey));
        var obj = {idkey:encidkey, nickname:app.self_user.nickname, payload:app.input};
        app.websocket.send(JSON.stringify(obj));
        app.input = "";
      },
    },
    mounted: function () {
      document.getElementById("id_salt").focus();
    },
    computed: {
      crack_time: function() {
        return zxcvbn(this.self_user.password).crack_times_display.offline_slow_hashing_1e4_per_second;
      },
    },
  });
</script>

</body>
</html>
